{% from "macros.html" import success_rate_display, stat_or_dash %}
{# Build a lookup dict from orchestration_stats for O(1) access by name #}
{% set stats_lookup = {} %}
{% for stat in state.orchestration_stats %}
    {% set _ = stats_lookup.update({stat.orchestration_name: stat}) %}
{% endfor %}
{# Number of columns in the orchestrations table - update if columns are added/removed #}
{% set orch_table_columns = 7 %}
{% if projects %}
<div class="nested-accordion">
    {% for project in projects %}
    <div class="nested-accordion-item">
        <div class="nested-accordion-header" onclick="toggleNestedAccordion(this)">
            <span class="collapse-icon">&#9654;</span>
            <strong>{{ project.identifier }}</strong>
            <span class="badge ml-2">{{ project.count }} orchestration{% if project.count != 1 %}s{% endif %}</span>
            <div class="bulk-toggle-buttons">
                <button class="btn-sm btn-success"
                        hx-post="/api/orchestrations/bulk-toggle"
                        hx-vals='js:{"source": encodeURIComponent("{{ source_type }}"), "identifier": encodeURIComponent("{{ project.identifier }}"), "enabled": true}'
                        hx-swap="none"
                        hx-confirm="Enable all orchestrations in {{ project.identifier }}?"
                        hx-on::after-request="handleToggleResponse(event)"
                        onclick="event.stopPropagation()"
                        aria-label="Enable all orchestrations in {{ project.identifier }}">
                    Enable All
                </button>
                <button class="btn-sm btn-danger"
                        hx-post="/api/orchestrations/bulk-toggle"
                        hx-vals='js:{"source": encodeURIComponent("{{ source_type }}"), "identifier": encodeURIComponent("{{ project.identifier }}"), "enabled": false}'
                        hx-swap="none"
                        hx-confirm="Disable all orchestrations in {{ project.identifier }}?"
                        hx-on::after-request="handleToggleResponse(event)"
                        onclick="event.stopPropagation()"
                        aria-label="Disable all orchestrations in {{ project.identifier }}">
                    Disable All
                </button>
            </div>
        </div>
        <div class="nested-accordion-content">
            <table class="nested-table">
                <tr>
                    <th>Name</th>
                    <th>Trigger Tags</th>
                    <th>Last Run</th>
                    <th>Runs</th>
                    <th>Success Rate</th>
                    <th>Avg Duration</th>
                    <th>Status</th>
                </tr>
                {% for orch in project.orchestrations %}
                {% set orch_stats = stats_lookup.get(orch.name) %}
                <tr class="clickable-row"
                    onclick="toggleOrchestrationDetail(this, '{{ orch.name }}')"
                    aria-expanded="false"
                    aria-label="Click to view details for {{ orch.name }}">
                    <td><strong>{{ orch.name }}</strong></td>
                    <td>
                        {% if orch.trigger_tags %}
                            {% for tag in orch.trigger_tags %}
                            <span class="tag">{{ tag }}</span>
                            {% endfor %}
                        {% else %}
                        <span style="color: var(--text-secondary);">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% call(v) stat_or_dash(orch_stats and orch_stats.last_run_at) %}
                        {{ orch_stats.last_run_at.strftime('%b %d %H:%M') }}
                        {% endcall %}
                    </td>
                    <td>
                        {% call(v) stat_or_dash(orch_stats) %}
                        {{ v.total_runs }}
                        {% endcall %}
                    </td>
                    <td>
                        {% call(v) stat_or_dash(orch_stats) %}
                        {{ success_rate_display(v.success_rate, state.success_rate_green_threshold, state.success_rate_yellow_threshold) }}
                        {% endcall %}
                    </td>
                    <td>
                        {% call(v) stat_or_dash(orch_stats) %}
                        {{ "%.1f" | format(v.avg_duration_seconds) }}s
                        {% endcall %}
                    </td>
                    <td>
                        <label class="toggle-switch" onclick="event.stopPropagation()">
                            <input type="checkbox"
                                   class="toggle-switch__input"
                                   {% if orch.enabled %}checked{% endif %}
                                   hx-post="/api/orchestrations/{{ orch.name }}/toggle"
                                   hx-vals='{"enabled": {{ "false" if orch.enabled else "true" }}}'
                                   hx-swap="none"
                                   hx-on::after-request="handleToggleResponse(event)">
                            <span class="toggle-switch__slider"></span>
                        </label>
                    </td>
                </tr>
                <tr class="orchestration-detail-row" id="detail-row-{{ orch.name }}">
                    <td colspan="{{ orch_table_columns }}"
                        hx-get="/partials/orchestration_detail/{{ orch.name }}"
                        hx-trigger="revealed once"
                        hx-swap="innerHTML">
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p style="color: var(--text-secondary);">No {% if source_type == 'github' %}GitHub repositories{% else %}Jira projects{% endif %} with orchestrations</p>
{% endif %}
