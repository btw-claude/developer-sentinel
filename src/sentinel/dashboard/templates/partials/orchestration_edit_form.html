{# Orchestration edit form - displayed when clicking Edit button #}
<div class="orchestration-detail">
    <form id="edit-form-{{ detail.name }}" aria-label="Edit step {{ detail.name }}">
        {# Header row with step name and action buttons #}
        <div class="detail-header">
            <h4 class="detail-header__name">{{ detail.name }}</h4>
            <div class="detail-header__actions">
                <button type="button" class="btn-sm btn-accent" onclick="submitOrchestrationEdit(this.closest('form'), '{{ detail.name }}')"
                        aria-label="Save step changes">Save</button>
                <button type="button" class="btn-sm btn-sm--secondary"
                        hx-get="/partials/orchestration_detail/{{ detail.name|urlencode }}"
                        hx-target="closest .orchestration-detail"
                        hx-swap="outerHTML"
                        aria-label="Cancel editing and return to detail view">Cancel</button>
            </div>
        </div>

        {# Trigger Config Section #}
        <div class="detail-section">
            <h4>Trigger Config</h4>
            <div class="config-grid" role="group" aria-label="Trigger configuration">
                <div class="detail-row">
                    <label class="detail-label" id="trigger-source-label">Source</label>
                    <div role="radiogroup" aria-labelledby="trigger-source-label">
                        <label class="form-radio-label">
                            <input type="radio" name="trigger_source" value="jira"
                                   {% if detail.trigger.source == 'jira' %}checked{% endif %}
                                   onchange="toggleTriggerFields(this.value)"
                                   aria-label="Jira trigger source">
                            Jira
                        </label>
                        <label>
                            <input type="radio" name="trigger_source" value="github"
                                   {% if detail.trigger.source == 'github' %}checked{% endif %}
                                   onchange="toggleTriggerFields(this.value)"
                                   aria-label="GitHub trigger source">
                            GitHub
                        </label>
                    </div>
                </div>

                {# Jira-specific fields #}
                <div id="jira-fields" style="display: none;">
                    <div class="detail-row">
                        <label class="detail-label" for="jira_project">Project</label>
                        <input type="text" id="jira_project" name="jira_project"
                               value="{{ detail.trigger.project or '' }}"
                               class="form-input">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="jira_jql_filter">JQL Filter</label>
                        <input type="text" id="jira_jql_filter" name="jira_jql_filter"
                               value="{{ detail.trigger.jql_filter or '' }}"
                               class="form-input">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="jira_tags">Tags</label>
                        <input type="text" id="jira_tags" name="jira_tags"
                               value="{% if detail.trigger.tags %}{{ detail.trigger.tags|join(', ') }}{% endif %}"
                               placeholder="comma-separated"
                               class="form-input">
                    </div>
                </div>

                {# GitHub-specific fields #}
                <div id="github-fields" style="display: none;">
                    <div class="detail-row">
                        <label class="detail-label" for="github_project_number">Project Number</label>
                        <input type="number" id="github_project_number" name="github_project_number"
                               value="{{ detail.trigger.project_number or '' }}"
                               class="form-input">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" id="project-scope-label">Project Scope</label>
                        <div role="radiogroup" aria-labelledby="project-scope-label">
                            <label class="form-radio-label">
                                <input type="radio" name="github_project_scope" value="org"
                                       {% if detail.trigger.project_scope == 'org' %}checked{% endif %}
                                       aria-label="Organization scope">
                                Org
                            </label>
                            <label>
                                <input type="radio" name="github_project_scope" value="user"
                                       {% if detail.trigger.project_scope == 'user' %}checked{% endif %}
                                       aria-label="User scope">
                                User
                            </label>
                        </div>
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="github_project_owner">Project Owner</label>
                        <input type="text" id="github_project_owner" name="github_project_owner"
                               value="{{ detail.trigger.project_owner or '' }}"
                               class="form-input">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="github_project_filter">Project Filter</label>
                        <input type="text" id="github_project_filter" name="github_project_filter"
                               value="{{ detail.trigger.project_filter or '' }}"
                               class="form-input">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="github_labels">Labels</label>
                        <input type="text" id="github_labels" name="github_labels"
                               value="{% if detail.trigger.labels %}{{ detail.trigger.labels|join(', ') }}{% endif %}"
                               placeholder="comma-separated"
                               class="form-input">
                    </div>
                </div>
            </div>
        </div>

        {# Agent Config Section #}
        <div class="detail-section">
            <h4>Agent Config</h4>
            <div class="config-grid">
                <div class="detail-row">
                    <label class="detail-label" for="agent_type">Agent Type</label>
                    <select id="agent_type" name="agent_type"
                            onchange="toggleCursorMode(this.value)"
                            aria-required="true"
                            class="form-input">
                        <option value="claude" {% if detail.agent.agent_type == 'claude' %}selected{% endif %}>Claude</option>
                        <option value="cursor" {% if detail.agent.agent_type == 'cursor' %}selected{% endif %}>Cursor</option>
                        <option value="codex" {% if detail.agent.agent_type == 'codex' %}selected{% endif %}>Codex</option>
                    </select>
                </div>

                <div class="detail-row" id="cursor-mode-row" style="display: none;">
                    <label class="detail-label" for="cursor_mode">Cursor Mode</label>
                    <select id="cursor_mode" name="cursor_mode"
                            class="form-input">
                        <option value="agent" {% if detail.agent.cursor_mode == 'agent' %}selected{% endif %}>Agent</option>
                        <option value="plan" {% if detail.agent.cursor_mode == 'plan' %}selected{% endif %}>Plan</option>
                        <option value="ask" {% if detail.agent.cursor_mode == 'ask' %}selected{% endif %}>Ask</option>
                    </select>
                </div>

                <div class="detail-row">
                    <label class="detail-label" for="model">Model</label>
                    <input type="text" id="model" name="model"
                           value="{{ detail.agent.model or '' }}"
                           class="form-input">
                </div>

                <div class="detail-row">
                    <label class="detail-label" for="timeout_seconds">Timeout (seconds)</label>
                    <input type="number" id="timeout_seconds" name="timeout_seconds"
                           value="{{ detail.agent.timeout_seconds or '' }}"
                           class="form-input">
                </div>
            </div>

            <div class="prompt-block-container">
                <label class="detail-label" for="prompt">Prompt</label>
                <textarea id="prompt" name="prompt" rows="8"
                          aria-required="true"
                          class="form-textarea--full">{{ detail.agent.prompt or '' }}</textarea>
            </div>

            {# GitHub Context Sub-form #}
            <div class="form-subsection">
                <h5 class="form-subsection__heading">GitHub Context</h5>
                <div class="config-grid">
                    <div class="detail-row">
                        <label class="detail-label" for="github_host">Host</label>
                        <input type="text" id="github_host" name="github_host"
                               value="{{ detail.agent.github.host if detail.agent.github else '' }}"
                               class="form-input--nested">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="github_org">Organization</label>
                        <input type="text" id="github_org" name="github_org"
                               value="{{ detail.agent.github.org if detail.agent.github else '' }}"
                               class="form-input--nested">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="github_repo">Repository</label>
                        <input type="text" id="github_repo" name="github_repo"
                               value="{{ detail.agent.github.repo if detail.agent.github else '' }}"
                               class="form-input--nested">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="github_branch">Branch</label>
                        <input type="text" id="github_branch" name="github_branch"
                               value="{{ detail.agent.github.branch if detail.agent.github else '' }}"
                               class="form-input--nested">
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="github_create_branch">Create Branch</label>
                        <label>
                            <input type="checkbox" id="github_create_branch" name="github_create_branch"
                                   {% if detail.agent.github and detail.agent.github.create_branch %}checked{% endif %}>
                            Yes
                        </label>
                    </div>
                    <div class="detail-row">
                        <label class="detail-label" for="github_base_branch">Base Branch</label>
                        <input type="text" id="github_base_branch" name="github_base_branch"
                               value="{{ detail.agent.github.base_branch if detail.agent.github else '' }}"
                               class="form-input--nested">
                    </div>
                </div>
            </div>
        </div>

        {# Retry Config Section #}
        <div class="detail-section">
            <h4>Retry Config</h4>
            <div class="config-grid">
                <div class="detail-row">
                    <label class="detail-label" for="max_attempts">Max Attempts</label>
                    <input type="number" id="max_attempts" name="max_attempts"
                           value="{{ detail.retry.max_attempts or 1 }}"
                           min="1"
                           aria-required="true"
                           class="form-input">
                </div>
                <div class="detail-row">
                    <label class="detail-label" for="success_patterns">Success Patterns</label>
                    <textarea id="success_patterns" name="success_patterns" rows="3"
                              placeholder="one pattern per line"
                              class="form-textarea">{% if detail.retry.success_patterns %}{{ detail.retry.success_patterns|join('\n') }}{% endif %}</textarea>
                </div>
                <div class="detail-row">
                    <label class="detail-label" for="failure_patterns">Failure Patterns</label>
                    <textarea id="failure_patterns" name="failure_patterns" rows="3"
                              placeholder="one pattern per line"
                              class="form-textarea">{% if detail.retry.failure_patterns %}{{ detail.retry.failure_patterns|join('\n') }}{% endif %}</textarea>
                </div>
                <div class="detail-row">
                    <label class="detail-label" id="default-status-label">Default Status</label>
                    <div role="radiogroup" aria-labelledby="default-status-label">
                        <label class="form-radio-label">
                            <input type="radio" name="default_status" value="success"
                                   {% if detail.retry.default_status == 'success' %}checked{% endif %}
                                   aria-label="Default status: success">
                            Success
                        </label>
                        <label>
                            <input type="radio" name="default_status" value="failure"
                                   {% if detail.retry.default_status == 'failure' %}checked{% endif %}
                                   aria-label="Default status: failure">
                            Failure
                        </label>
                    </div>
                </div>
                <div class="detail-row">
                    <label class="detail-label" for="default_outcome">Default Outcome</label>
                    <input type="text" id="default_outcome" name="default_outcome"
                           value="{{ detail.retry.default_outcome or '' }}"
                           class="form-input">
                </div>
            </div>
        </div>

        {# Outcomes Section #}
        <div class="detail-section">
            <h4>Outcomes</h4>
            <ul id="outcomes-container" aria-label="Outcome definitions">
                {% if detail.outcomes %}
                    {% for outcome in detail.outcomes %}
                <li class="outcome-row">
                    <input type="text" name="outcome_name" value="{{ outcome.name }}" placeholder="Outcome name"
                           aria-label="Outcome name"
                           class="form-input">
                    <textarea name="outcome_patterns" rows="2" placeholder="Patterns (one per line)"
                              aria-label="Outcome patterns, one per line"
                              class="form-textarea">{{ outcome.patterns|join('\n') }}</textarea>
                    <input type="text" name="outcome_add_tag" value="{{ outcome.add_tag or '' }}" placeholder="Add tag"
                           aria-label="Tag to add for this outcome"
                           class="form-input">
                    <button type="button" onclick="removeOutcome(this)" class="btn-sm btn-danger" style="height: fit-content;"
                            aria-label="Remove outcome {{ outcome.name }}">Remove</button>
                </li>
                    {% endfor %}
                {% endif %}
            </ul>
            <button type="button" onclick="addOutcome()" class="btn-sm btn-accent" style="margin-top: 0.5rem;"
                    aria-label="Add a new outcome">Add Outcome</button>
        </div>

        {# Lifecycle Hooks Section #}
        <div class="detail-section">
            <h4>Lifecycle Hooks</h4>
            <div class="config-grid">
                <div class="detail-row">
                    <label class="detail-label" for="on_start_add_tag">On Start Add Tag</label>
                    <input type="text" id="on_start_add_tag" name="on_start_add_tag"
                           value="{{ detail.lifecycle.on_start_add_tag or '' }}"
                           class="form-input">
                </div>
                <div class="detail-row">
                    <label class="detail-label" for="on_complete_remove_tag">On Complete Remove Tag</label>
                    <input type="text" id="on_complete_remove_tag" name="on_complete_remove_tag"
                           value="{{ detail.lifecycle.on_complete_remove_tag or '' }}"
                           class="form-input">
                </div>
                <div class="detail-row">
                    <label class="detail-label" for="on_complete_add_tag">On Complete Add Tag</label>
                    <input type="text" id="on_complete_add_tag" name="on_complete_add_tag"
                           value="{{ detail.lifecycle.on_complete_add_tag or '' }}"
                           class="form-input">
                </div>
                <div class="detail-row">
                    <label class="detail-label" for="on_failure_add_tag">On Failure Add Tag</label>
                    <input type="text" id="on_failure_add_tag" name="on_failure_add_tag"
                           value="{{ detail.lifecycle.on_failure_add_tag or '' }}"
                           class="form-input">
                </div>
            </div>
        </div>

    </form>
</div>

<script>
    {# Toggle between Jira and GitHub trigger fields #}
    function toggleTriggerFields(source) {
        const jiraFields = document.getElementById('jira-fields');
        const githubFields = document.getElementById('github-fields');

        if (source === 'jira') {
            jiraFields.style.display = 'block';
            githubFields.style.display = 'none';
        } else {
            jiraFields.style.display = 'none';
            githubFields.style.display = 'block';
        }
    }

    {# Toggle cursor_mode visibility based on agent_type #}
    function toggleCursorMode(agentType) {
        const cursorModeRow = document.getElementById('cursor-mode-row');
        cursorModeRow.style.display = agentType === 'cursor' ? 'flex' : 'none';
    }

    {# Add a new outcome row #}
    function addOutcome() {
        const container = document.getElementById('outcomes-container');
        const row = document.createElement('li');
        row.className = 'outcome-row';
        row.innerHTML = `
            <input type="text" name="outcome_name" placeholder="Outcome name"
                   aria-label="Outcome name"
                   class="form-input">
            <textarea name="outcome_patterns" rows="2" placeholder="Patterns (one per line)"
                      aria-label="Outcome patterns, one per line"
                      class="form-textarea"></textarea>
            <input type="text" name="outcome_add_tag" placeholder="Add tag"
                   aria-label="Tag to add for this outcome"
                   class="form-input">
            <button type="button" onclick="removeOutcome(this)" class="btn-sm btn-danger" style="height: fit-content;"
                    aria-label="Remove this outcome">Remove</button>
        `;
        container.appendChild(row);
    }

    {# Remove an outcome row #}
    function removeOutcome(button) {
        button.closest('.outcome-row').remove();
    }

    {# Initialize visibility immediately (HTMX-loaded content, DOMContentLoaded already fired) #}
    (function() {
        var triggerSource = document.querySelector('input[name="trigger_source"]:checked');
        if (triggerSource) {
            toggleTriggerFields(triggerSource.value);
        }

        var agentType = document.getElementById('agent_type');
        if (agentType) {
            toggleCursorMode(agentType.value);
        }
    })();
</script>
