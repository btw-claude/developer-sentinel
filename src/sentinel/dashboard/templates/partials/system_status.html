{# Security audit complete - no external links (target="_blank") in this template #}
{% from "macros.html" import humanize_duration %}
{# Macro to format relative time from a datetime object #}
{% macro format_relative_time(dt, now) %}
    {%- if dt %}
        {%- set diff_seconds = (now - dt).total_seconds() | int %}
        {%- if diff_seconds < 0 %}
            just now
        {%- elif diff_seconds < 60 %}
            {{ diff_seconds }} second{{ 's' if diff_seconds != 1 else '' }} ago
        {%- elif diff_seconds < 3600 %}
            {%- set mins = diff_seconds // 60 %}
            {{ mins }} minute{{ 's' if mins != 1 else '' }} ago
        {%- elif diff_seconds < 86400 %}
            {%- set hours = diff_seconds // 3600 %}
            {{ hours }} hour{{ 's' if hours != 1 else '' }} ago
        {%- else %}
            {%- set days = diff_seconds // 86400 %}
            {{ days }} day{{ 's' if days != 1 else '' }} ago
        {%- endif %}
    {%- else %}
        Never
    {%- endif %}
{% endmacro %}

{% if state.system_status %}
{# Cache current time for relative calculations #}
{% set now = state.system_status.start_time.__class__.now() %}
<table>
    <tr>
        <th>Metric</th>
        <th>Value</th>
    </tr>
    <tr>
        <td>Thread Pool Usage</td>
        <td>
            {# Edge case handling for None values #}
            {% set used = state.system_status.used_slots if state.system_status.used_slots is not none else 0 %}
            {% set max = state.system_status.max_slots if state.system_status.max_slots is not none else 0 %}
            <span class="{% if used == max and max > 0 %}status-warn{% elif used > 0 %}status-ok{% endif %}">
                {{ used }}
            </span>
            / {{ max }} slots
        </td>
    </tr>
    <tr>
        <td>Poll Interval</td>
        <td>
            {# Edge case handling for None poll_interval #}
            {% if state.system_status.poll_interval is not none %}
            {{ state.system_status.poll_interval }}s
            {% else %}
            <span class="text-secondary">N/A</span>
            {% endif %}
        </td>
    </tr>
    <tr>
        <td>Last Jira Poll</td>
        <td>
            {% if state.system_status.last_jira_poll %}
            {# Relative time with absolute time tooltip, timezone indicator #}
            <span title="{{ state.system_status.last_jira_poll.strftime('%Y-%m-%d %H:%M:%S %Z') }}">
                {{ format_relative_time(state.system_status.last_jira_poll, now) }}
            </span>
            <span class="text-secondary-small">
                ({{ state.system_status.last_jira_poll.strftime('%H:%M:%S %Z') | replace(' ', '') or state.system_status.last_jira_poll.strftime('%H:%M:%S') }} local)
            </span>
            {% else %}
            <span class="text-secondary">Never</span>
            {% endif %}
        </td>
    </tr>
    <tr>
        <td>Last GitHub Poll</td>
        <td>
            {% if state.system_status.last_github_poll %}
            {# Relative time with absolute time tooltip, timezone indicator #}
            <span title="{{ state.system_status.last_github_poll.strftime('%Y-%m-%d %H:%M:%S %Z') }}">
                {{ format_relative_time(state.system_status.last_github_poll, now) }}
            </span>
            <span class="text-secondary-small">
                ({{ state.system_status.last_github_poll.strftime('%H:%M:%S %Z') | replace(' ', '') or state.system_status.last_github_poll.strftime('%H:%M:%S') }} local)
            </span>
            {% else %}
            <span class="text-secondary">Never</span>
            {% endif %}
        </td>
    </tr>
    <tr>
        <td>Process Uptime</td>
        <td>
            {# Edge case handling for None uptime_seconds #}
            {% if state.system_status.uptime_seconds is not none %}
            {{ humanize_duration(state.system_status.uptime_seconds) }}
            {% else %}
            <span class="text-secondary">N/A</span>
            {% endif %}
        </td>
    </tr>
    <tr>
        <td>Started At</td>
        <td>
            {# Edge case handling for None start_time, timezone indicator #}
            {% if state.system_status.start_time %}
            {{ state.system_status.start_time.strftime('%Y-%m-%d %H:%M:%S') }}
            <span class="text-secondary-small">
                ({{ state.system_status.start_time.strftime('%Z') or 'local' }})
            </span>
            {% else %}
            <span class="text-secondary">Unknown</span>
            {% endif %}
        </td>
    </tr>
</table>
{% else %}
<p class="text-secondary">System status unavailable</p>
{% endif %}
