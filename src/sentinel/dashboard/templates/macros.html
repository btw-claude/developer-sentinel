{# Security audit complete - no external links (target="_blank") in this template #}
{# Reusable Jinja2 macros for badge and formatting components #}
{#
  Escaping convention: Within Jinja2 comment blocks, use doubled percent
  signs (%%) instead of single % when showing Jinja2 tag examples. This
  prevents the template engine from interpreting the examples as real
  Jinja2 tags. See the macros below for examples of this convention.
#}

{#
  Macro to render a badge with automatic state-based styling.

  Determines the badge variant class based on the active/total counts:
  - badge--inactive: When active_count is 0 (nothing active)
  - badge--success: When active_count equals total_count (all active)
  - (default): When partially active (some but not all)

  @param active_count - Number of currently active items
  @param total_count - Total number of items
  @returns The badge element with appropriate styling class
#}
{% macro status_badge(active_count, total_count) %}
<span class="badge{% if active_count == 0 %} badge--inactive{% elif active_count == total_count %} badge--success{% endif %}">{{ active_count }}/{{ total_count }}</span>
{%- endmacro %}

{#
  Macro to render a success rate with consistent color coding.

  Determines the text color class based on configurable success rate thresholds:
  - text-success (green): When rate >= green_threshold (default 90.0%)
  - text-warning (yellow): When rate >= yellow_threshold (default 70.0%)
  - text-danger (red): When rate < yellow_threshold

  Note: The default values (90.0, 70.0) match DEFAULT_GREEN_THRESHOLD and
  DEFAULT_YELLOW_THRESHOLD in sentinel.config. In practice, callers always
  pass explicit threshold values from DashboardState, so these defaults serve
  only as a safety net.

  @param rate - Success rate as a percentage (0.0 - 100.0)
  @param green_threshold - Minimum rate for green display (default 90.0)
  @param yellow_threshold - Minimum rate for yellow display (default 70.0)
  @returns A span element with the rate formatted to one decimal place and appropriate color class
#}
{% macro success_rate_display(rate, green_threshold=90.0, yellow_threshold=70.0) %}
<span class="{% if rate >= green_threshold %}text-success{% elif rate >= yellow_threshold %}text-warning{% else %}text-danger{% endif %}">{{ "%.1f" | format(rate) }}%</span>
{%- endmacro %}

{#
  Macro to render a statistic value or a dash placeholder.

  When the provided value is truthy, the caller block content is rendered.
  When the value is falsy (None, 0, empty string, etc.), a styled dash
  placeholder is rendered instead.

  This macro uses Jinja2's call block pattern — it must be invoked with
  {%% call stat_or_dash(value) %%}...{%% endcall %%} syntax so that the
  content between the tags is available via caller().

  Usage (see top-of-file note on %% escaping convention):
    {%% call(v) stat_or_dash(orch_stats) %%}
        {{ v.total_runs }}
    {%% endcall %%}

  @param value - The value to check for truthiness
  @returns The caller block content if value is truthy, otherwise a dash placeholder
#}
{% macro stat_or_dash(value) %}
{%- if value -%}
{{ caller(value) }}
{%- else -%}
<span style="color: var(--text-secondary);">-</span>
{%- endif -%}
{%- endmacro %}

{#
  Macro to format a duration in seconds as a compact human-readable string.

  Converts a numeric total_seconds value to "Xh Ym Zs" format, omitting
  leading zero-valued components (e.g. "5m 30s" instead of "0h 5m 30s").
  Useful for paused-duration, uptime, and similar elapsed-time displays.

  Extracted from service_health.html (DS-825) so that the same
  hours/minutes/seconds formatting pattern can be reused across
  dashboard partials (e.g., uptime, last-check timestamps).

  @param total_seconds - Duration in seconds (float or int)
  @returns Formatted duration string, e.g. "2h 5m 30s", "5m 30s", or "30s"
#}
{% macro humanize_duration(total_seconds) %}
{%- set ts = total_seconds | int -%}
{%- set h = ts // 3600 -%}
{%- set m = (ts % 3600) // 60 -%}
{%- set s = ts % 60 -%}
{%- if h > 0 -%}
{{ h }}h {{ m }}m {{ s }}s
{%- elif m > 0 -%}
{{ m }}m {{ s }}s
{%- else -%}
{{ s }}s
{%- endif -%}
{%- endmacro %}

{#
  Macro to format a seconds-ago value as a compact relative time string.

  Converts a numeric seconds_ago value to a friendly "Xs ago", "Xm ago",
  or "Xh ago" format depending on magnitude. Useful for last-check-time
  and other "time since" displays.

  Extracted from service_health.html (DS-825) so that the same
  relative-time formatting pattern can be reused across dashboard partials.

  @param seconds_ago - Number of seconds elapsed (float or int)
  @returns Formatted relative time string, e.g. "45s ago", "12m ago", or "3h ago"
#}
{% macro humanize_seconds_ago(seconds_ago) %}
{%- set sa = seconds_ago | int -%}
{%- if sa < 60 -%}
{{ sa }}s ago
{%- elif sa < 3600 -%}
{{ sa // 60 }}m ago
{%- else -%}
{{ sa // 3600 }}h ago
{%- endif -%}
{%- endmacro %}

{#
  Macro to format a seconds-ago value as a detailed relative time string
  with sub-unit precision within each display tier.

  Similar to humanize_seconds_ago but includes the next-smaller unit within
  each tier for additional precision:
  - Seconds tier (< 60s): shows seconds only, e.g. "45s ago"
  - Minutes tier (60s–3599s): shows minutes and seconds, e.g. "1m 59s ago"
  - Hours tier (≥ 3600s): shows hours and minutes, e.g. "2h 5m ago"

  Note: seconds are intentionally dropped at the hours tier to keep output
  concise (e.g. 3601s renders as "1h ago", not "1h 0m 1s ago").

  Added as a complement to humanize_seconds_ago (DS-833) to provide
  higher-precision time displays. The compact humanize_seconds_ago macro
  remains the default for dashboard displays where brevity is preferred.

  @param seconds_ago - Number of seconds elapsed (float or int)
  @returns Formatted relative time string, e.g. "45s ago", "1m 59s ago", or "2h 5m ago"
#}
{% macro humanize_seconds_ago_detailed(seconds_ago) %}
{%- set sa = seconds_ago | int -%}
{%- set h = sa // 3600 -%}
{%- set m = (sa % 3600) // 60 -%}
{%- set s = sa % 60 -%}
{%- if h > 0 and m > 0 -%}
{{ h }}h {{ m }}m ago
{%- elif h > 0 -%}
{{ h }}h ago
{%- elif m > 0 and s > 0 -%}
{{ m }}m {{ s }}s ago
{%- elif m > 0 -%}
{{ m }}m ago
{%- else -%}
{{ sa }}s ago
{%- endif -%}
{%- endmacro %}
