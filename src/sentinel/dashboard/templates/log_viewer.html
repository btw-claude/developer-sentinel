{# Security audit complete - no external links (target="_blank") in this template #}
{% extends "base.html" %}

{% block title %}Log Viewer - Developer Sentinel{% endblock %}

{% block extra_head %}
<style>
    .log-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .log-select-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .log-select-group label {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .log-select-group select {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--accent);
        border-radius: 4px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        cursor: pointer;
    }

    .log-select-group select:focus {
        outline: none;
        border-color: var(--success);
    }

    .control-buttons {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
    }

    .control-btn {
        background-color: var(--accent);
        color: var(--text-primary);
        border: 1px solid var(--accent);
        border-radius: 4px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-btn:hover {
        background-color: var(--bg-primary);
    }

    .control-btn.active {
        background-color: var(--success);
        border-color: var(--success);
    }

    .control-btn.paused {
        background-color: var(--warning);
        border-color: var(--warning);
        color: var(--bg-primary);
    }

    .log-container {
        background-color: #0d1117;
        border: 1px solid var(--accent);
        border-radius: 8px;
        height: calc(100vh - 280px);
        min-height: 400px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .log-header {
        background-color: var(--bg-secondary);
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .log-header .log-title {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .log-header .log-status {
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--text-secondary);
    }

    .status-indicator.connected {
        background-color: var(--success);
    }

    .status-indicator.disconnected {
        background-color: var(--danger);
    }

    .log-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.8125rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: #e6edf3;
    }

    .log-content::-webkit-scrollbar {
        width: 8px;
    }

    .log-content::-webkit-scrollbar-track {
        background: var(--bg-primary);
    }

    .log-content::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 4px;
    }

    .log-content::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }

    .log-line {
        padding: 1px 0;
    }

    .log-line:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
        text-align: center;
    }

    .empty-state p {
        margin: 0.5rem 0;
    }

    .empty-state-subtitle {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 0.25rem; /* explicit override of inherited .empty-state p margin */
    }

    .scroll-indicator {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        background-color: var(--accent);
        color: var(--text-primary);
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        display: none;
        opacity: 0.9;
    }

    .scroll-indicator:hover {
        opacity: 1;
    }

    .log-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Log Viewer</h2>

    <div class="log-controls">
        <div class="log-select-group">
            <label for="step-select">Step:</label>
            <select id="step-select">
                <option value="">Select step...</option>
                {% for log_file in log_files %}
                <option value="{{ log_file.orchestration }}">{{ log_file.orchestration }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="log-select-group">
            <label for="logfile-select">Log File:</label>
            <select id="logfile-select">
                <option value="">Select log file...</option>
            </select>
        </div>

        <div class="control-buttons">
            <button id="pause-btn" class="control-btn" disabled>
                <span id="pause-icon">⏸</span>
                <span id="pause-text">Pause</span>
            </button>
            <button id="refresh-btn" class="control-btn">
                ↻ Refresh
            </button>
        </div>
    </div>

    <div class="log-container">
        <div class="log-header">
            <span class="log-title" id="log-title"></span>
            <span class="log-status">
                <span class="status-indicator" id="status-indicator"></span>
                <span id="status-text"></span>
            </span>
        </div>
        <div class="log-wrapper">
            <div class="log-content" id="log-content">
            </div>
            <div class="scroll-indicator" id="scroll-indicator">
                ↓ New content available
            </div>
        </div>
    </div>
</div>

<script>
// Store log files data for JavaScript access
const logFilesData = {{ log_files | tojson | safe }};

// State
let eventSource = null;
let isPaused = false;
let autoScroll = true;
let currentStep = '';
let currentLogFile = '';

// DOM elements
const stepSelect = document.getElementById('step-select');
const logfileSelect = document.getElementById('logfile-select');
const logContent = document.getElementById('log-content');
const pauseBtn = document.getElementById('pause-btn');
const pauseIcon = document.getElementById('pause-icon');
const pauseText = document.getElementById('pause-text');
const statusIndicator = document.getElementById('status-indicator');
const statusText = document.getElementById('status-text');
const logTitle = document.getElementById('log-title');
const scrollIndicator = document.getElementById('scroll-indicator');

/**
 * Wrap a plain-text message in empty-state HTML markup.
 * Keeps translatable strings free of HTML (i18n-ready).
 * @param {string} text - Primary message text
 * @param {string} [subtitle] - Optional secondary helper text rendered in a smaller font
 */
function wrapEmptyState(text, subtitle) {
    const div = document.createElement('div');
    div.className = 'empty-state';
    const p = document.createElement('p');
    p.textContent = text;
    div.appendChild(p);
    if (subtitle) {
        const sub = document.createElement('p');
        sub.className = 'empty-state-subtitle';
        sub.textContent = subtitle;
        div.appendChild(sub);
    }
    return div.outerHTML;
}

// Update log file dropdown when step changes
function updateLogFileOptions() {
    const step = stepSelect.value;
    currentStep = step;

    // Clear current selection
    logfileSelect.innerHTML = '<option value="">Select log file...</option>';

    if (!step) {
        return;
    }

    // Find files for this step
    const stepData = logFilesData.find(d => d.orchestration === step);
    if (stepData && stepData.files) {
        stepData.files.forEach(file => {
            const option = document.createElement('option');
            option.value = file.filename;
            option.textContent = file.display_name;
            logfileSelect.appendChild(option);
        });
    }
}

// Load selected log file
function loadLogFile() {
    const logFile = logfileSelect.value;
    currentLogFile = logFile;

    // Close existing connection
    closeSSE();

    if (!currentStep || !logFile) {
        logContent.innerHTML = wrapEmptyState(UI_MESSAGES.LOG_VIEWER.SELECT_PROMPT, UI_MESSAGES.LOG_VIEWER.SELECT_PROMPT_SUBTITLE);
        logTitle.textContent = UI_MESSAGES.LOG_VIEWER.NO_FILE_SELECTED;
        pauseBtn.disabled = true;
        return;
    }

    // Update title
    logTitle.textContent = `${currentStep}/${logFile}`;
    pauseBtn.disabled = false;

    // Clear content and show loading
    logContent.innerHTML = wrapEmptyState(UI_MESSAGES.LOG_VIEWER.LOADING);

    // Connect to SSE endpoint
    connectSSE();
}

// Connect to SSE endpoint
function connectSSE() {
    if (!currentStep || !currentLogFile) {
        return;
    }

    const url = `/api/logs/stream/${encodeURIComponent(currentStep)}/${encodeURIComponent(currentLogFile)}`;
    eventSource = new EventSource(url);

    eventSource.onopen = function() {
        updateStatus(true);
    };

    eventSource.onmessage = function(event) {
        if (isPaused) {
            scrollIndicator.style.display = 'block';
            return;
        }

        handleLogData(event.data);
    };

    eventSource.addEventListener('initial', function(event) {
        // Initial content - replace the loading message
        logContent.innerHTML = '';
        handleLogData(event.data);
    });

    eventSource.addEventListener('append', function(event) {
        if (isPaused) {
            scrollIndicator.style.display = 'block';
            return;
        }
        handleLogData(event.data);
    });

    eventSource.onerror = function() {
        updateStatus(false);
        // Try to reconnect after 5 seconds
        setTimeout(() => {
            if (currentStep && currentLogFile && !isPaused) {
                connectSSE();
            }
        }, 5000);
    };
}

// Handle incoming log data
function handleLogData(data) {
    try {
        const parsed = JSON.parse(data);
        if (parsed.content !== undefined) {
            if (parsed.type === 'initial') {
                logContent.innerHTML = '';
            }
            appendLogContent(parsed.content);
        }
    } catch (e) {
        // Plain text data
        appendLogContent(data);
    }
}

// Append content to log viewer
function appendLogContent(content) {
    if (!content) return;

    // Remove empty state if present
    const emptyState = logContent.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }

    // Check if we should auto-scroll before adding content
    const shouldScroll = autoScroll && isAtBottom();

    // Append the content
    const lines = content.split('\n');
    lines.forEach(line => {
        const lineDiv = document.createElement('div');
        lineDiv.className = 'log-line';
        lineDiv.textContent = line;
        logContent.appendChild(lineDiv);
    });

    // Auto-scroll if enabled and was at bottom
    if (shouldScroll) {
        scrollToBottom();
    } else if (!isAtBottom()) {
        scrollIndicator.style.display = 'block';
    }
}

// Check if scrolled to bottom
function isAtBottom() {
    const threshold = 50;
    return logContent.scrollHeight - logContent.scrollTop - logContent.clientHeight < threshold;
}

// Scroll to bottom
function scrollToBottom() {
    logContent.scrollTop = logContent.scrollHeight;
    scrollIndicator.style.display = 'none';
}

// Toggle pause state
function togglePause() {
    isPaused = !isPaused;

    if (isPaused) {
        pauseBtn.classList.add('paused');
        pauseIcon.textContent = UI_MESSAGES.LOG_VIEWER.RESUME_ICON;
        pauseText.textContent = UI_MESSAGES.LOG_VIEWER.RESUME;
    } else {
        pauseBtn.classList.remove('paused');
        pauseIcon.textContent = UI_MESSAGES.LOG_VIEWER.PAUSE_ICON;
        pauseText.textContent = UI_MESSAGES.LOG_VIEWER.PAUSE;
        scrollIndicator.style.display = 'none';
        scrollToBottom();
    }
}

// Update connection status
function updateStatus(connected) {
    if (connected) {
        statusIndicator.classList.add('connected');
        statusIndicator.classList.remove('disconnected');
        statusText.textContent = UI_MESSAGES.LOG_VIEWER.CONNECTED;
    } else {
        statusIndicator.classList.remove('connected');
        statusIndicator.classList.add('disconnected');
        statusText.textContent = UI_MESSAGES.LOG_VIEWER.DISCONNECTED;
    }
}

// Close SSE connection
function closeSSE() {
    if (eventSource) {
        eventSource.close();
        eventSource = null;
    }
    updateStatus(false);
}

// Refresh log files list
function refreshLogFiles() {
    window.location.reload();
}

// Handle scroll events to update auto-scroll state
logContent.addEventListener('scroll', function() {
    autoScroll = isAtBottom();
    if (autoScroll) {
        scrollIndicator.style.display = 'none';
    }
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    closeSSE();
});

// Event listeners for controls (replacing inline handlers with addEventListener)
stepSelect.addEventListener('change', updateLogFileOptions);
logfileSelect.addEventListener('change', loadLogFile);
pauseBtn.addEventListener('click', togglePause);
document.getElementById('refresh-btn').addEventListener('click', refreshLogFiles);
scrollIndicator.addEventListener('click', scrollToBottom);

// Initialize UI text from centralized constants (single source of truth)
logTitle.textContent = UI_MESSAGES.LOG_VIEWER.NO_FILE_SELECTED;
statusText.textContent = UI_MESSAGES.LOG_VIEWER.DISCONNECTED;
logContent.innerHTML = wrapEmptyState(UI_MESSAGES.LOG_VIEWER.SELECT_PROMPT, UI_MESSAGES.LOG_VIEWER.SELECT_PROMPT_SUBTITLE);

// Auto-select from URL query parameters (for direct links from Running Steps)
// Added user feedback when invalid URL parameters are detected
(function initFromUrlParams() {
    const params = new URLSearchParams(window.location.search);
    // Keep 'orchestration' URL param for backward compat with Running Steps links
    const step = params.get('orchestration');
    const file = params.get('file');

    if (step) {
        // Validate step parameter exists in dropdown before selecting
        const stepOption = Array.from(stepSelect.options).find(opt => opt.value === step);
        if (stepOption) {
            stepSelect.value = step;
            updateLogFileOptions();

            if (file) {
                // Validate file parameter exists in dropdown before selecting
                const fileOption = Array.from(logfileSelect.options).find(opt => opt.value === file);
                if (fileOption) {
                    logfileSelect.value = file;
                    loadLogFile();
                } else {
                    // User feedback for invalid file parameter
                    console.warn(UI_MESSAGES.DEBUG.INVALID_FILE_PARAM(file, step));
                    showToast('warning', UI_MESSAGES.TOAST.LOG_FILE_NOT_FOUND(file));
                }
            }
        } else {
            // User feedback for invalid step parameter
            console.warn(UI_MESSAGES.DEBUG.INVALID_STEP_PARAM(step));
            showToast('warning', UI_MESSAGES.TOAST.STEP_NOT_FOUND(step));
        }
    }
})();
</script>
{% endblock %}
