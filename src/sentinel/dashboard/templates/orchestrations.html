{# Security audit complete - no external links (target="_blank") in this template #}
{% extends "base.html" %}
{% from "macros.html" import status_badge %}

{% block title %}Orchestrations - Developer Sentinel{% endblock %}

{% block extra_head %}
<script>
    /**
     * Preserve nested accordion expanded state across HTMX auto-refresh.
     *
     * The Jira and GitHub orchestration sections auto-refresh every 10s via HTMX,
     * replacing innerHTML. This destroys any expanded state on nested accordion items
     * and orchestration detail rows. These event listeners capture which items are
     * expanded before the swap and re-apply the expanded state after the new content
     * settles.
     *
     * Scoped to orchestrations page only (loaded via extra_head block).
     * Uses data-identifier attributes on .nested-accordion-item elements (added in DS-1062)
     * and IDs on .orchestration-detail-row elements for reliable matching across DOM rebuilds.
     */
    (function() {
        'use strict';

        /** @type {Set<string>} Expanded nested accordion item data-identifier values */
        let expandedAccordionItems = new Set();
        /** @type {Set<string>} Expanded orchestration detail row IDs */
        let expandedDetailRows = new Set();

        /**
         * Before HTMX swaps new content, capture the currently expanded state.
         * Records data-identifier values of expanded .nested-accordion-item elements
         * and IDs of expanded .orchestration-detail-row elements.
         */
        document.body.addEventListener('htmx:beforeSwap', function(event) {
            const target = event.detail.target;
            if (!target) {
                return;
            }

            // Capture expanded nested accordion items by data-identifier
            const expandedItems = target.querySelectorAll('.nested-accordion-item.expanded');
            if (expandedItems.length > 0) {
                expandedAccordionItems = new Set();
                expandedItems.forEach(function(item) {
                    const identifier = item.getAttribute('data-identifier');
                    if (identifier) {
                        expandedAccordionItems.add(identifier);
                    }
                });
            }

            // Capture expanded orchestration detail rows by ID
            const expandedRows = target.querySelectorAll('.orchestration-detail-row.expanded');
            if (expandedRows.length > 0) {
                expandedDetailRows = new Set();
                expandedRows.forEach(function(row) {
                    if (row.id) {
                        expandedDetailRows.add(row.id);
                    }
                });
            }
        });

        /**
         * After HTMX settles new content, re-apply the expanded state.
         * Restores expanded class on matching .nested-accordion-item elements
         * and expanded class + aria-expanded on matching .orchestration-detail-row elements.
         */
        document.body.addEventListener('htmx:afterSettle', function(event) {
            const target = event.detail.target;
            if (!target) {
                return;
            }

            // Restore expanded nested accordion items
            if (expandedAccordionItems.size > 0) {
                target.querySelectorAll('.nested-accordion-item').forEach(function(item) {
                    const identifier = item.getAttribute('data-identifier');
                    if (identifier && expandedAccordionItems.has(identifier)) {
                        item.classList.add('expanded');
                    }
                });
            }

            // Restore expanded orchestration detail rows
            if (expandedDetailRows.size > 0) {
                target.querySelectorAll('.orchestration-detail-row').forEach(function(row) {
                    if (row.id && expandedDetailRows.has(row.id)) {
                        row.classList.add('expanded');
                        // Also restore aria-expanded on the corresponding clickable row
                        const clickableRow = row.previousElementSibling;
                        if (clickableRow && clickableRow.classList.contains('clickable-row')) {
                            clickableRow.setAttribute('aria-expanded', 'true');
                        }
                    }
                });
            }
        });
    })();
</script>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin-bottom: 0;">Orchestrations</h2>
        <button type="button" class="btn-sm btn-accent"
                hx-get="/partials/orchestration_create"
                hx-target="#create-form-container"
                hx-swap="innerHTML"
                onclick="document.getElementById('create-form-container').style.display = 'block';"
                style="padding: 0.5rem 1rem; font-size: 0.9rem;">
            New Step
        </button>
    </div>
</div>

<div id="create-form-container" class="card" style="display: none;">
    <!-- Creation form will be loaded here via HTMX -->
</div>

<div class="card collapsible-section">
    <div class="collapsible-header expanded"
         data-collapsible-target="jira-orchestrations-content"
         hx-get="/partials/orchestrations?source=jira"
         hx-target="#jira-orchestrations-content"
         hx-swap="innerHTML"
         hx-trigger="click[!isExpanded('jira-orchestrations-content')]"
         hx-on::after-request="toggleCollapsibleSection(this)">
        <h2>
            <span class="collapse-icon rotated">&#9654;</span>
            Jira Orchestrations
            {{ status_badge(state.active_jira_projects_count, state.jira_projects | length) }}
        </h2>
    </div>
    <div id="jira-orchestrations-content" class="collapsible-content expanded"
         hx-get="/partials/orchestrations?source=jira"
         hx-trigger="load, every 10s[isExpanded('jira-orchestrations-content')]"
         hx-swap="innerHTML">
        <!-- Content loaded via HTMX, auto-refreshes every 10s when expanded -->
    </div>
</div>

<div class="card collapsible-section">
    <div class="collapsible-header expanded"
         data-collapsible-target="github-orchestrations-content"
         hx-get="/partials/orchestrations?source=github"
         hx-target="#github-orchestrations-content"
         hx-swap="innerHTML"
         hx-trigger="click[!isExpanded('github-orchestrations-content')]"
         hx-on::after-request="toggleCollapsibleSection(this)">
        <h2>
            <span class="collapse-icon rotated">&#9654;</span>
            GitHub Orchestrations
            {{ status_badge(state.active_github_repos_count, state.github_repos | length) }}
        </h2>
    </div>
    <div id="github-orchestrations-content" class="collapsible-content expanded"
         hx-get="/partials/orchestrations?source=github"
         hx-trigger="load, every 10s[isExpanded('github-orchestrations-content')]"
         hx-swap="innerHTML">
        <!-- Content loaded via HTMX, auto-refreshes every 10s when expanded -->
    </div>
</div>

<div class="card">
    <h2>Active Versions</h2>
    {% if state.active_versions %}
    <table>
        <tr>
            <th>Name</th>
            <th>Version ID</th>
            <th>Source File</th>
            <th>Active Executions</th>
        </tr>
        {% for version in state.active_versions %}
        <tr>
            <td>{{ version.name }}</td>
            <td><code>{{ version.version_id[:8] }}</code></td>
            <td>{{ version.source_file }}</td>
            <td>{{ version.active_executions }}</td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p style="color: var(--text-secondary);">No active versions</p>
    {% endif %}
</div>

{% if state.pending_removal_versions %}
<div class="card">
    <h2>Pending Removal</h2>
    <table>
        <tr>
            <th>Name</th>
            <th>Version ID</th>
            <th>Active Executions</th>
        </tr>
        {% for version in state.pending_removal_versions %}
        <tr>
            <td>{{ version.name }}</td>
            <td><code>{{ version.version_id[:8] }}</code></td>
            <td>{{ version.active_executions }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}
{% endblock %}
