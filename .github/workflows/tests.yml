name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ---------------------------------------------------------------------------
  # Branch-strictness gate (DS-1040)
  # ---------------------------------------------------------------------------
  # Centralised job that determines whether CI failures should block the
  # build.  Downstream jobs reference its outputs instead of duplicating
  # inline branch-detection expressions.  See the composite action at
  # .github/actions/branch-strictness/action.yml for the decision logic.
  # ---------------------------------------------------------------------------
  branch-context:
    name: Branch Context
    runs-on: ubuntu-latest
    # These output mappings use ${{ }} expressions evaluated by the GitHub
    # Actions expression engine (not by bash).  They simply forward the
    # composite-action step outputs to job-level outputs so that downstream
    # jobs (e.g. integration-tests) can reference them via the `needs` context.
    outputs:
      is-strict: ${{ steps.strictness.outputs.is-strict }}
      continue-on-error: ${{ steps.strictness.outputs.continue-on-error }}
      strictness-level: ${{ steps.strictness.outputs.strictness-level }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Determine branch strictness
        id: strictness
        uses: ./.github/actions/branch-strictness

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python 3.13
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/unit -v --cov=sentinel --cov-report=xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@0561704f0f02c16a585d4c7555e57fa2e44cf909 # v5.5.2
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    needs: [branch-context]
    runs-on: ubuntu-latest
    # Integration tests are optional and run separately
    # They require external services (Jira, GitHub APIs)
    # Tests will be skipped if credentials are not available
    #
    # Per-branch behavior (DS-1036, refactored in DS-1040):
    # - On main: integration test failures are strictly enforced
    # - On develop / PRs: integration tests remain informational
    # The continue-on-error value is now supplied by the branch-context job
    # via the branch-strictness composite action, providing a single source
    # of truth for per-branch CI behavior.
    #
    # Note: The == operator below is evaluated by the GitHub Actions
    # expression engine (inside ${{ }} delimiters), not by bash.  The
    # expression compares the string output from branch-context against the
    # literal 'true' and yields a boolean that the `continue-on-error` key
    # consumes directly.
    continue-on-error: ${{ needs.branch-context.outputs.continue-on-error == 'true' }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python 3.13
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run integration tests
        env:
          # Jira API credentials (optional - tests skip if not set)
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          # GitHub API credentials (optional - tests skip if not set)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TEST_REPO: ${{ secrets.GITHUB_TEST_REPO }}
        run: |
          pytest tests/integration -v -m integration --tb=short

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python 3.13
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run isort check
        run: isort --check-only --diff src tests

      - name: Run ruff
        run: ruff check src tests

      - name: Run pydocstyle
        run: pydocstyle src

      - name: Run mypy
        run: mypy src
