# Developer Sentinel Orchestration Configuration
# ====================================
#
# Template Variables:
# -------------------
# The agent prompt supports template variables that are substituted with
# actual values from the Jira issue and GitHub context. Use these to give
# the agent exactly the context it needs:
#
# Jira Variables:
#   {jira_issue_key}    - Issue key (e.g., "PROJ-123")
#   {jira_summary}      - Issue title/summary
#   {jira_description}  - Full issue description
#   {jira_status}       - Current status (e.g., "In Progress")
#   {jira_assignee}     - Assignee display name
#   {jira_labels}       - Comma-separated labels
#   {jira_comments}     - Recent comments (last 3, formatted)
#   {jira_links}        - Comma-separated linked issue keys
#
# GitHub Variables:
#   {github_host}       - GitHub host (e.g., "github.com")
#   {github_org}        - Organization name
#   {github_repo}       - Repository name

orchestrations:
  # Code Review Orchestration
  # -------------------------
  # Watches for Jira issues tagged with "needs-code-review" and
  # sends them to a Claude agent for code review.
  - name: "code-review"

    # Trigger configuration
    # Defines which Jira issues activate this orchestration
    trigger:
      source: jira              # Only "jira" is supported initially
      project: "DS"           # Jira project key to watch
      jql_filter: "status != Closed"  # Additional JQL filter (optional)
      tags:                     # Labels that trigger this orchestration
        - "needs-code-review"

    # Agent configuration
    # Defines the Claude agent's behavior
    agent:
      # The prompt/instructions for the agent
      # The agent will receive the Jira issue context along with this prompt
      prompt: |
        You are a code review assistant. Review the code changes referenced
        in this Jira issue and provide feedback.

        Focus on:
        - Code correctness and potential bugs
        - Security vulnerabilities
        - Performance considerations
        - Code style and best practices

        After reviewing, post your findings as a comment on the Jira issue.
        If there's a linked GitHub PR, also post a review there.

        End your response with SUCCESS if the review was completed, or
        FAILURE if you encountered issues.

      # Tools available to the agent
      # Options: jira, confluence, github
      tools:
        - jira
        - github

      # GitHub context (required if github tool is enabled)
      github:
        host: "github.com"
        org: "btw-claude"
        repo: "developer-sentinel"

    # Retry configuration
    # Defines how to handle agent failures
    retry:
      max_attempts: 3           # Maximum retry attempts

      # Patterns in agent response that indicate success
      success_patterns:
        - "SUCCESS"
        - "completed successfully"
        - "review complete"

      # Patterns in agent response that indicate failure
      failure_patterns:
        - "FAILURE"
        - "failed"
        - "error"
        - "could not"

    # On start actions
    # What to do immediately when an issue is picked up
    # This prevents duplicate processing if poll interval < processing time
    on_start:
      add_tag: "code-review-in-progress"  # Automatically removed after processing

    # On complete actions
    # What to do after successful processing
    # Note: trigger tag is already removed when processing starts
    on_complete:
      add_tag: "code-reviewed"          # Add completion tag

    # On failure actions
    # What to do when all retry attempts are exhausted
    on_failure:
      add_tag: "human-intervention-required"          # Add failure tag for investigation
