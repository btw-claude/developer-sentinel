# Test Project Orchestration Configuration
# ====================================
#
# Template Variables:
# -------------------
# The agent prompt supports template variables that are substituted with
# actual values from the Jira issue and GitHub context. Use these to give
# the agent exactly the context it needs:
#
# Jira Variables:
#   {jira_issue_key}    - Issue key (e.g., "PROJ-123")
#   {jira_summary}      - Issue title/summary
#   {jira_description}  - Full issue description
#   {jira_status}       - Current status (e.g., "In Progress")
#   {jira_assignee}     - Assignee display name
#   {jira_labels}       - Comma-separated labels
#   {jira_comments}     - Recent comments (last 3, formatted)
#   {jira_links}        - Comma-separated linked issue keys
#
# GitHub Variables:
#   {github_host}       - GitHub host (e.g., "github.com")
#   {github_org}        - Organization name
#   {github_repo}       - Repository name

orchestrations:
  # Development Orchestration
  # -------------------------
  # Watches for Jira issues tagged with "needs-code-review" and
  # sends them to a Claude agent for code review.
  - name: "development"

    # Trigger configuration
    # Defines which Jira issues activate this orchestration
    trigger:
      source: jira              # Only "jira" is supported initially
      project: "TP"           # Jira project key to watch
      jql_filter: "status != Closed"  # Additional JQL filter (optional)
      tags:                     # Labels that trigger this orchestration
        - "ready-for-development"

    # Agent configuration
    # Defines the Claude agent's behavior
    agent:
      # The prompt/instructions for the agent
      # The agent will receive the Jira issue context along with this prompt
      prompt: |
        You are a development assistant. 
        
        Focus on:
        - Code correctness and potential bugs
        - Security vulnerabilities
        - Performance considerations
        - Code style and best practices

        Create a task list for yourself:
        
        1. Review the code changes referenced in this Jira issue
        2. Clone the repository into your current working directory
        3. Create a feature branch based on the main branch
        4. Address the goals of the Jira issue
        5. Commit the changes and push to the feature branch
        6. Create a pull request to the main branch using the GitHub MCP tools
        7. Update the Jira with a pull request reference (org, repo, and pull request id) and a label: 'needs-code-review'
        8. End session by responding with SUCCESS if all the tasks were completed, or FAILURE if you encountered issues that prevented you from executing tasks 1-7

      # Tools available to the agent
      # Options: jira, confluence, github
      tools:
        - jira
        - confluence
        - github

      # GitHub context (required if github tool is enabled)
      github:
        host: "github.com"
        org: "btw-claude"
        repo: "test-project"

    # Retry configuration
    # Defines how to handle agent failures
    retry:
      max_attempts: 3           # Maximum retry attempts

      # Patterns in agent response that indicate success
      success_patterns:
        - "SUCCESS"
        - "completed successfully"
        - "review complete"

      # Patterns in agent response that indicate failure
      failure_patterns:
        - "FAILURE"
        - "failed"
        - "error"
        - "could not"

    # On start actions
    # What to do immediately when an issue is picked up
    # This prevents duplicate processing if poll interval < processing time
    on_start:
      add_tag: "development-in-progress"  # Automatically removed after processing

    # On complete actions
    # What to do after successful processing
    # Note: trigger tag is already removed when processing starts
    on_complete:
      add_tag: "needs-code-review"          # Add completion tag

    # On failure actions
    # What to do when all retry attempts are exhausted
    on_failure:
      add_tag: "human-intervention-required"          # Add failure tag for investigation

  # Code Review Orchestration
  # -------------------------
  # Watches for Jira issues tagged with "needs-code-review" and
  # sends them to a Claude agent for code review.
  - name: "code-review"

    # Trigger configuration
    # Defines which Jira issues activate this orchestration
    trigger:
      source: jira              # Only "jira" is supported initially
      project: "TP"           # Jira project key to watch
      jql_filter: "status != Closed"  # Additional JQL filter (optional)
      tags:                     # Labels that trigger this orchestration
        - "needs-code-review"

    # Agent configuration
    # Defines the Claude agent's behavior
    agent:
      # The prompt/instructions for the agent
      # The agent will receive the Jira issue context along with this prompt
      prompt: |
        You are a code review assistant.

        Focus on:
        - Code correctness and potential bugs
        - Security vulnerabilities
        - Performance considerations
        - Code style and best practices

        Create a task list for yourself:
        
        1. Review the pull request referenced in this Jira issue using the GitHub MCP tools
        2. Update the pull request with any inline comments using the GitHub MCP tools
        3. Update the Jira issue with overall comments
        4. If you decide not to ask for code changes, are there minor changes that are best to address later?  Create a Jira issue for the future changes.
        4. Run the following psuedo code block to give your final response:
         if (unable to finish due to tool issues)
          echo "FAILURE"
         else if (comments made and changes are requested)
          echo "CHANGES_REQUESTED"
         else
          echo "SUCCESS"


      # Tools available to the agent
      # Options: jira, confluence, github
      tools:
        - jira
        - github

      # GitHub context (required if github tool is enabled)
      github:
        host: "github.com"
        org: "btw-claude"
        repo: "test-project"

    # Retry configuration
    # Defines how to handle agent failures
    retry:
      max_attempts: 3           # Maximum retry attempts

      # Patterns in agent response that indicate success
      success_patterns:
        - "SUCCESS"
        - "completed successfully"
        - "review complete"

      # Patterns in agent response that indicate failure
      failure_patterns:
        - "FAILURE"
        - "failed"
        - "error"
        - "could not"

    # On start actions
    # What to do immediately when an issue is picked up
    # This prevents duplicate processing if poll interval < processing time
    on_start:
      add_tag: "code-review-in-progress"  # Automatically removed after processing

    # On complete actions
    # What to do after successful processing
    # Note: trigger tag is already removed when processing starts
    on_complete:
      add_tag: "code-reviewed"        # Add completion tag

    # On failure actions
    # What to do when all retry attempts are exhausted
    on_failure:
      add_tag: "human-intervention-required"          # Add failure tag for investigation



  # Code Review Orchestration
  # -------------------------
  # Watches for Jira issues tagged with "needs-code-review" and
  # sends them to a Claude agent for code review.
  - name: "code-review"

    # Trigger configuration
    # Defines which Jira issues activate this orchestration
    trigger:
      source: jira              # Only "jira" is supported initially
      project: "TP"           # Jira project key to watch
      jql_filter: "status != Closed"  # Additional JQL filter (optional)
      tags:                     # Labels that trigger this orchestration
        - "needs-code-review"

    # Agent configuration
    # Defines the Claude agent's behavior
    agent:
      # The prompt/instructions for the agent
      # The agent will receive the Jira issue context along with this prompt
      prompt: |
        4. If you are here, you have been successful at tasks 1 and 2.  Follow steps 5 and 6.
        5. Find the next Jira issue available.  If the previous issue was the sole blocker of another Jira, that would be a good candidate.  Otherwise, search for open issues that are not blocked.  Add a label to that Jira issue: 'ready-for-development'


      # Tools available to the agent
      # Options: jira, confluence, github
      tools:
        - jira
        - github

      # GitHub context (required if github tool is enabled)
      github:
        host: "github.com"
        org: "btw-claude"
        repo: "test-project"

    # Retry configuration
    # Defines how to handle agent failures
    retry:
      max_attempts: 3           # Maximum retry attempts

      # Patterns in agent response that indicate success
      success_patterns:
        - "SUCCESS"
        - "completed successfully"
        - "review complete"

      # Patterns in agent response that indicate failure
      failure_patterns:
        - "FAILURE"
        - "failed"
        - "error"
        - "could not"

    # On start actions
    # What to do immediately when an issue is picked up
    # This prevents duplicate processing if poll interval < processing time
    on_start:
      add_tag: "code-review-in-progress"  # Automatically removed after processing

    # On complete actions
    # What to do after successful processing
    # Note: trigger tag is already removed when processing starts
    on_complete:
      add_tag: "code-reviewed"        # Add completion tag

    # On failure actions
    # What to do when all retry attempts are exhausted
    on_failure:
      add_tag: "human-intervention-required"          # Add failure tag for investigation
