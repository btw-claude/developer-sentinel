# Example Orchestration Configuration
# ====================================
#
# This file demonstrates the complete orchestration configuration schema.
# Copy and modify this file to create your own orchestrations.
#
# Each orchestration defines:
#   - name: Unique identifier for the orchestration
#   - trigger: What Jira issues to watch for
#   - agent: How the Claude agent should process them
#   - retry: How to handle failures and determine success
#   - on_start: What to do when processing begins (prevents duplicate processing)
#   - on_complete: What to do after successful processing
#   - on_failure: What to do when all retries are exhausted
#
# Template Variables:
# -------------------
# The agent prompt supports template variables that are substituted with
# actual values from the Jira issue and GitHub context. Use these to give
# the agent exactly the context it needs:
#
# Jira Variables:
#   {jira_issue_key}    - Issue key (e.g., "PROJ-123")
#   {jira_summary}      - Issue title/summary
#   {jira_description}  - Full issue description
#   {jira_status}       - Current status (e.g., "In Progress")
#   {jira_assignee}     - Assignee display name
#   {jira_labels}       - Comma-separated labels
#   {jira_comments}     - Recent comments (last 3, formatted)
#   {jira_links}        - Comma-separated linked issue keys
#
# GitHub Variables:
#   {github_host}       - GitHub host (e.g., "github.com")
#   {github_org}        - Organization name
#   {github_repo}       - Repository name
#
# Tag-based Workflow:
# -------------------
# Sentinel uses a stateless, tag-based workflow:
#   1. Issues with trigger tags are picked up for processing
#   2. Trigger tag is removed and in-progress tag is added (prevents duplicate processing)
#   3. On success: in-progress tag is removed, completion tag is added
#   4. On failure: in-progress tag is removed, failure tag is added
#
# This ensures issues are processed exactly once and failure states are visible.
#
# Outcome-based Tags:
# -------------------
# For more nuanced workflows, you can define multiple success outcomes with
# different tags. For example, a code review might result in "approved" or
# "changes-requested", each adding a different label to the Jira issue.
# See the "code-review-with-outcomes" example below.

orchestrations:
  # Code Review Orchestration
  # -------------------------
  # Watches for Jira issues tagged with "needs-code-review" and
  # sends them to a Claude agent for code review.
  - name: "code-review"

    # Trigger configuration
    # Defines which Jira issues activate this orchestration
    trigger:
      source: jira              # Only "jira" is supported initially
      project: "PROJ"           # Jira project key to watch
      jql_filter: "status != Closed"  # Additional JQL filter (optional)
      tags:                     # Labels that trigger this orchestration
        - "needs-code-review"

    # Agent configuration
    # Defines the Claude agent's behavior
    agent:
      # The prompt/instructions for the agent
      # Use template variables like {jira_issue_key} to include issue context
      prompt: |
        You are a code review assistant. Review issue {jira_issue_key}.

        ## Issue Details
        **Summary:** {jira_summary}
        **Status:** {jira_status}
        **Assignee:** {jira_assignee}

        **Description:**
        {jira_description}

        **Repository:** {github_org}/{github_repo}

        ## Your Task
        Review the code changes and provide feedback. Focus on:
        - Code correctness and potential bugs
        - Security vulnerabilities
        - Performance considerations
        - Code style and best practices

        Post your findings as a comment on the Jira issue.
        If there's a linked GitHub PR, also post a review there.

        End your response with SUCCESS if the review was completed, or
        FAILURE if you encountered issues.

      # Tools available to the agent
      # Options: jira, confluence, github
      tools:
        - jira
        - github

      # GitHub context (required if github tool is enabled)
      github:
        host: "github.com"
        org: "your-org"
        repo: "your-repo"

    # Retry configuration
    # Defines how to handle agent failures
    retry:
      max_attempts: 3           # Maximum retry attempts

      # Patterns in agent response that indicate success
      success_patterns:
        - "SUCCESS"
        - "completed successfully"
        - "review complete"

      # Patterns in agent response that indicate failure
      failure_patterns:
        - "FAILURE"
        - "failed"
        - "error"
        - "could not"

    # On start actions
    # What to do immediately when an issue is picked up
    # This prevents duplicate processing if poll interval < processing time
    on_start:
      add_tag: "sentinel-processing"  # Automatically removed after processing

    # On complete actions
    # What to do after successful processing
    # Note: trigger tag is already removed when processing starts
    on_complete:
      add_tag: "code-reviewed"          # Add completion tag

    # On failure actions
    # What to do when all retry attempts are exhausted
    on_failure:
      add_tag: "review-failed"          # Add failure tag for investigation

  # Documentation Orchestration
  # ---------------------------
  # Example of a documentation-focused orchestration
  - name: "update-docs"

    trigger:
      source: jira
      project: "PROJ"
      tags:
        - "needs-docs"

    agent:
      prompt: |
        You are a documentation assistant. Update documentation for {jira_issue_key}.

        ## Issue Details
        **Summary:** {jira_summary}

        **Description:**
        {jira_description}

        ## Your Task
        Based on the Jira issue above, update the relevant Confluence documentation.
        After updating, post a summary as a comment on the Jira issue.

        End your response with SUCCESS or FAILURE.

      tools:
        - jira
        - confluence

    retry:
      max_attempts: 2
      success_patterns:
        - "SUCCESS"
        - "documentation updated"
      failure_patterns:
        - "FAILURE"
        - "could not update"

    on_start:
      add_tag: "sentinel-processing"

    on_complete:
      add_tag: "docs-updated"

    on_failure:
      add_tag: "docs-update-failed"

  # Code Review with Outcomes
  # -------------------------
  # This example shows how to use outcomes for different success types.
  # Instead of a single success tag, different outcomes add different labels.
  - name: "code-review-with-outcomes"

    trigger:
      source: jira
      project: "PROJ"
      tags:
        - "needs-code-review"

    agent:
      prompt: |
        You are a code review assistant. Review {jira_issue_key}: {jira_summary}

        ## Issue Description
        {jira_description}

        ## Repository
        {github_org}/{github_repo}

        ## Your Task
        Review the code changes in the linked GitHub PR and provide feedback.

        After reviewing:
        - If the code looks good, end with "APPROVED: [brief summary]"
        - If changes are needed, end with "CHANGES REQUESTED: [what needs to change]"

        Always post your review comments on the GitHub PR.

      tools:
        - jira
        - github

      github:
        host: "github.com"
        org: "your-org"
        repo: "your-repo"

      # Optional timeout in seconds (5 minutes)
      timeout_seconds: 300

    # Retry configuration
    # failure_patterns trigger retries for actual errors (API failures, etc.)
    retry:
      max_attempts: 3
      failure_patterns:
        - "ERROR"
        - "could not access"
        - "API failed"
        - "connection timeout"
      # default_outcome is used when no outcome patterns match (optional)
      default_outcome: "approved"

    # Outcomes define different success types with different tags
    # Each outcome has:
    #   - name: identifier for the outcome
    #   - patterns: strings that indicate this outcome (case-insensitive)
    #               Use "regex:" prefix for regex patterns
    #   - add_tag: label to add when this outcome is matched
    outcomes:
      - name: approved
        patterns:
          - "APPROVED"
          - "LGTM"
          - "looks good"
        add_tag: "code-reviewed"

      - name: changes-requested
        patterns:
          - "CHANGES REQUESTED"
          - "REQUEST CHANGES"
          - "needs changes"
        add_tag: "changes-requested"

    on_start:
      add_tag: "sentinel-processing"

    # on_complete is not needed when using outcomes - the outcome's add_tag
    # is used instead. on_complete is a fallback for backwards compatibility.

    on_failure:
      add_tag: "review-failed"
